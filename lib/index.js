'use strict';var _regenerator=require('babel-runtime/regenerator'),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator'),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_crypto=require('crypto'),_fs=require('mz/fs'),_zlib=require('mz/zlib'),_path=require('path'),_mimeTypes=require('mime-types'),_compressible=require('compressible'),_compressible2=_interopRequireDefault(_compressible),_fsReaddirRecursive=require('fs-readdir-recursive'),_fsReaddirRecursive2=_interopRequireDefault(_fsReaddirRecursive),_koa=require('koa');Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var safeDecodeURIComponent=function(a){try{return decodeURIComponent(a)}catch(b){return a}},loadFile=function(a,b,c,d){var f=(0,_path.normalize)((0,_path.join)(c.prefix,a)),g=d[f]=d[f]?d[f]:{},i=g.path=(0,_path.join)(b,a),j=(0,_fs.statSync)(i),k=(0,_fs.readFileSync)(i);return g.cacheControl=c.cacheControl,g.maxAge=g.maxAge?g.maxAge:c.maxAge||0,g.type=g.mime=(0,_mimeTypes.lookup)(f)||'application/octet-stream',g.mtime=j.mtime,g.length=j.size,g.md5=(0,_crypto.createHash)('md5').update(k).digest('base64'),g.buffer=k,k=null,g},staticCache=function(a){var b=a.dir;a.prefix='/';var c={},d=!!a.gzip;return(0,_fsReaddirRecursive2.default)(b).forEach(function(f){loadFile(f,b,a,c)}),function(){var f=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function g(i,j){var k,l,m,n,o,p,q,r,u;return _regenerator2.default.wrap(function(w){for(;;)switch(w.prev=w.next){case 0:if('HEAD'===i.method||'GET'===i.method){w.next=4;break}return w.next=3,j();case 3:return w.abrupt('return');case 4:if(0===i.path.indexOf(a.prefix)){w.next=8;break}return w.next=7,j();case 7:return w.abrupt('return');case 8:if(k=safeDecodeURIComponent((0,_path.normalize)(i.path)),l=c[k],l){w.next=43;break}if('.'!==(0,_path.basename)(k)[0]){w.next=15;break}return w.next=14,j();case 14:return w.abrupt('return');case 15:return m=void 0,w.prev=16,w.next=19,(0,_fs.statSync)((0,_path.normalize)((0,_path.join)(b,k+'/index.html'))).isFile();case 19:m=w.sent,w.next=24;break;case 22:w.prev=22,w.t0=w['catch'](16);case 24:return m&&(k+='/index.html'),k.charAt(0)===_path.sep&&(k=k.slice(1)),n=void 0,w.prev=27,w.next=30,(0,_fs.statSync)((0,_path.join)(b,k));case 30:n=w.sent,w.next=38;break;case 33:return w.prev=33,w.t1=w['catch'](27),w.next=37,j();case 37:return w.abrupt('return');case 38:if(n.isFile()){w.next=42;break}return w.next=41,j();case 41:return w.abrupt('return');case 42:l=loadFile(k,b,a,c);case 43:if(i.status=200,d&&i.vary('Accept-Encoding'),l.buffer){w.next=50;break}return w.next=48,(0,_fs.statSync)(l.path);case 48:o=w.sent,o.mtime>l.mtime&&(l.mtime=o.mtime,l.md5=null,l.length=o.size);case 50:if(i.response.lastModified=l.mtime,l.md5&&(i.response.etag=l.md5),!i.fresh){w.next=55;break}return i.status=304,w.abrupt('return');case 55:if(i.type=l.type,i.length=l.zipBuffer?l.zipBuffer.length:l.length,i.set('cache-control','public, max-age='+l.maxAge),l.md5&&i.set('content-md5',l.md5),'HEAD'!==i.method){w.next=61;break}return w.abrupt('return');case 61:if(p='gzip'===i.acceptsEncodings('gzip'),!l.zipBuffer){w.next=65;break}return p?(i.set('content-encoding','gzip'),i.body=l.zipBuffer):i.body=l.buffer,w.abrupt('return');case 65:if(q=d&&1024<l.length&&p&&(0,_compressible2.default)(l.type),!l.buffer){w.next=77;break}if(!q){w.next=75;break}return w.next=70,(0,_zlib.gzip)(l.buffer);case 70:l.zipBuffer=w.sent,i.set('content-encoding','gzip'),i.body=l.zipBuffer,w.next=76;break;case 75:i.body=l.buffer;case 76:return w.abrupt('return');case 77:r=(0,_fs.createReadStream)(l.path),l.md5||(u=(0,_crypto.createHash)('md5'),r.on('data',u.update.bind(u)),r.on('end',function(){l.md5=u.digest('base64')})),a.extraHeaders&&Array.isArray(a.extraHeaders)&&a.extraHeaders.length&&a.extraHeaders.forEach(function(x){for(var y in x)i.append(y,x[y])}),i.body=r,q&&(i.remove('content-length'),i.set('content-encoding','gzip'),i.body=r.pipe((0,_zlib.createGzip)()));case 82:case'end':return w.stop();}},g,void 0,[[16,22],[27,33]])}));return function(){return f.apply(this,arguments)}}()};exports.default=staticCache;
